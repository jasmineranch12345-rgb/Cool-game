<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Arena Shooter Fixed</title>
<style>
  html,body{height:100%;margin:0;background:#0c0c0f;touch-action:none}
  canvas{display:block}
  #ui{position:fixed;inset:0;pointer-events:none;font-family:Segoe UI,Roboto,Arial;color:#fff}
  #health-bar{position:absolute;left:16px;top:14px;width:240px;height:20px;border:2px solid #fff;background:#222}
  #health-fill{height:100%;width:100%;background:linear-gradient(90deg,#5ee07a,#37b24d)}
  #hud2{position:absolute;left:16px;top:44px;display:flex;gap:16px}
  #score,#wave{font-size:18px}
  #gun{position:absolute;left:16px;top:74px;font-size:16px}
  #shield{position:absolute;left:16px;top:96px;font-size:14px}
  #pauseBtn{position:absolute;left:50%;top:14px;transform:translateX(-50%);pointer-events:auto;background:#222;color:#fff;border:1px solid #444;border-radius:10px;padding:8px 14px;font-size:16px}
  #menu,#gameover{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;z-index:40;font-size:18px;padding:20px}
  .menu-panel{max-width:980px;width:100%;text-align:center}
  .big-btn{display:inline-block;margin:12px;padding:12px 20px;background:#222;color:#fff;border-radius:10px;border:1px solid #444;font-size:18px}
  .gun-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:12px 0}
  .gun-card{border:1px solid #444;background:#141414;color:#fff;border-radius:10px;padding:10px;cursor:pointer;text-align:left}
  .gun-card h4{margin:0 0 6px;font-size:16px}
  .gun-card.selected{outline:2px solid #6ab4ff}
  .joystick{position:absolute;bottom:60px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.05);touch-action:none;pointer-events:auto}
  #moveStick{left:40px}
  #shootStick{right:40px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">
  <div id="health-bar"><div id="health-fill"></div></div>
  <div id="hud2"><div id="score">Score: 0</div><div id="wave">Wave: 1</div></div>
  <div id="gun">Gun: Pistol</div>
  <div id="shield">Shield: 0</div>
  <button id="pauseBtn">Pause</button>
</div>
<div id="menu">
  <div class="menu-panel">
    <h1>Arena Shooter</h1>
    <p>Select your starting gun:</p>
    <div class="gun-grid" id="gunSelect"></div>
    <button class="big-btn" id="startBtn">Start Game</button>
  </div>
</div>
<div id="gameover" style="display:none;">
  <div class="menu-panel">
    <h2>Game Over</h2>
    <p id="finalScore">Score: 0</p>
    <button class="big-btn" onclick="location.reload()">Restart</button>
  </div>
</div>
<div class="joystick" id="moveStick"></div>
<div class="joystick" id="shootStick"></div>

<script>
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;canvas.height=window.innerHeight;

let running=false,paused=false,wave=1,score=0;
let player={x:canvas.width/2,y:canvas.height/2,hp:100,shield:0,gun:"Pistol",fireCooldown:0};
let bullets=[],enemies=[],crates=[],obstacles=[];
const guns={
  "Pistol":{dmg:10,rate:400,speed:7},
  "SMG":{dmg:6,rate:120,speed:6},
  "Shotgun":{dmg:8,rate:800,speed:5},
  "Sniper":{dmg:35,rate:1200,speed:9},
  "Rocket":{dmg:50,rate:1500,speed:4}
};

// fill gun select
const gunSelect=document.getElementById("gunSelect");
Object.keys(guns).forEach(g=>{
  let div=document.createElement("div");
  div.className="gun-card";div.innerHTML="<h4>"+g+"</h4><small>dmg "+guns[g].dmg+"</small>";
  div.onclick=()=>{document.querySelectorAll(".gun-card").forEach(c=>c.classList.remove("selected"));div.classList.add("selected");player.gun=g;};
  if(g==="Pistol")div.classList.add("selected");
  gunSelect.appendChild(div);
});
document.getElementById("startBtn").onclick=()=>{document.getElementById("menu").style.display="none";running=true;spawnWave();gameLoop();};

// spawn wave
function spawnWave(){
  enemies=[];
  let pool=["basic"];
  if(wave>=2)pool.push("runner");
  if(wave>=3)pool.push("sniper");
  if(wave>=4)pool.push("exploder");
  if(wave>=5)pool.push("shielded");
  let count=6+Math.floor(Math.random()*5)+wave*1.5;
  for(let i=0;i<count;i++){
    let type=pool[Math.floor(Math.random()*pool.length)];
    let pos=spawnEdge();
    enemies.push({x:pos.x,y:pos.y,type,hp:20+wave*3});
  }
  if(wave%5===0){ // boss
    let pos=spawnEdge();
    enemies.push({x:pos.x,y:pos.y,type:"boss",hp:200+wave*30});
  }
  // spawn crates
  crates=[];
  for(let i=0;i<3;i++){
    crates.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,content:Math.random()<0.5?"gun":(Math.random()<0.5?"health":"shield")});
  }
  // spawn obstacles
  obstacles=[];
  for(let i=0;i<5;i++){obstacles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,w:60,h:60});}
}
function spawnEdge(){
  let side=Math.floor(Math.random()*4);
  if(side===0)return{x:0,y:Math.random()*canvas.height};
  if(side===1)return{x:canvas.width,y:Math.random()*canvas.height};
  if(side===2)return{x:Math.random()*canvas.width,y:0};
  return{x:Math.random()*canvas.width,y:canvas.height};
}

// joystick logic
let moveVec={x:0,y:0},shootVec={x:0,y:0};
function setupStick(stick,vec){
  let dragging=false;
  stick.addEventListener("touchstart",e=>{dragging=true;e.preventDefault();});
  stick.addEventListener("touchmove",e=>{
    if(!dragging)return;
    let r=stick.getBoundingClientRect();let cx=r.left+r.width/2,cy=r.top+r.height/2;
    let dx=e.touches[0].clientX-cx,dy=e.touches[0].clientY-cy;
    let d=Math.hypot(dx,dy);if(d>40){dx*=40/d;dy*=40/d;}
    vec.x=dx/40;vec.y=dy/40;
  });
  stick.addEventListener("touchend",()=>{dragging=false;vec.x=0;vec.y=0;});
}
setupStick(document.getElementById("moveStick"),moveVec);
setupStick(document.getElementById("shootStick"),shootVec);

function gameLoop(){
  if(!running)return;
  if(!paused)update();
  render();
  requestAnimationFrame(gameLoop);
}

function update(){
  // player move
  player.x+=moveVec.x*3;player.y+=moveVec.y*3;
  // shooting
  player.fireCooldown-=16;
  if((shootVec.x||shootVec.y)&&player.fireCooldown<=0){
    let g=guns[player.gun];
    let d=Math.hypot(shootVec.x,shootVec.y);
    bullets.push({x:player.x,y:player.y,vx:shootVec.x/d*g.speed,vy:shootVec.y/d*g.speed,dmg:g.dmg});
    player.fireCooldown=g.rate;
  }
  // bullets
  bullets=bullets.filter(b=>{
    b.x+=b.vx;b.y+=b.vy;
    // collide obstacles
    for(let o of obstacles){if(b.x>o.x&&b.x<o.x+o.w&&b.y>o.y&&b.y<o.y+o.h)return false;}
    // collide enemies
    for(let e of enemies){if(Math.hypot(b.x-e.x,b.y-e.y)<12){e.hp-=b.dmg;return false;}}
    return b.x>0&&b.x<canvas.width&&b.y>0&&b.y<canvas.height;
  });
  enemies=enemies.filter(e=>e.hp>0);
  // enemies move
  enemies.forEach(e=>{
    let dx=player.x-e.x,dy=player.y-e.y,d=Math.hypot(dx,dy);
    let spd=(e.type==="runner"?2:1);if(e.type==="boss")spd=1.2;
    e.x+=dx/d*spd;e.y+=dy/d*spd;
  });
  if(enemies.length===0){wave++;spawnWave();}
}

function render(){
  ctx.fillStyle="#0c0c0f";ctx.fillRect(0,0,canvas.width,canvas.height);
  // obstacles
  ctx.fillStyle="#666";obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));
  // crates
  crates.forEach(c=>{ctx.fillStyle=c.content==="gun"?"orange":(c.content==="health"?"green":"cyan");ctx.fillRect(c.x-10,c.y-10,20,20);});
  // player
  ctx.fillStyle="blue";ctx.beginPath();ctx.arc(player.x,player.y,15,0,Math.PI*2);ctx.fill();
  // enemies
  enemies.forEach(e=>{ctx.fillStyle=e.type==="boss"?"purple":"red";ctx.beginPath();ctx.arc(e.x,e.y,12,0,Math.PI*2);ctx.fill();});
  // bullets
  ctx.fillStyle="yellow";bullets.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill();});
}
</script>
</body>
</html>
